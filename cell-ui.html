<!DOCTYPE html>
<meta charset="utf-8">
<style>
    table { background: 'red'; cellspacing: 0; }
    table, td {  border: 0px solid black; background: 'none'; }

    .count { font-family: 'Arial Black', 'Arial Bold', Gadget, sans-serif;
        font-size: 45px; font-style: normal; font-variant: normal; font-weight: 500; line-height: 15.4px;
    }

    .med { font-family: 'Arial Black', 'Arial Bold', Gadget, sans-serif;
        font-size: 35px; font-style: normal; font-variant: normal; font-weight: 500; line-height: 30.4px;
        fill: none;
    }

    h2 { font-family: 'Arial Black', 'Arial Bold', Gadget, sans-serif;
        font-size: 60px; font-style: normal; font-variant: normal; font-weight: 500; line-height: 15.4px;
    }

    path  {
        fill: 'blue'
    }

    .btn-lg, .btn-group-lg>.btn {
        padding: 10px 16px;
        font-size: 18px;
        line-height: 1.33;
        border-radius: 6px;
    }

    .r45 {
        transform: rotate(60deg);
    }
</style>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/d3-selection-multi.v1.min.js"></script>
<script src="node_modules/socket.io-client/dist/socket.io.js"></script>
<!--
<script src='node_modules/jquery/dist/jquery.js' type='text/javascript'></script>
<script src="js/d3.min.js" type="text/Javascript"></script>
<script src="node_modules/d3-selection-multi/build/d3-selection-multi.min.js" type="text/Javascript">implements .attrs for d3.v4 GGG</script>
<script src="node_modules/socket.io/node_modules/socket.io-client/socket.io.js" type="text/Javascript"></script>
<script src="datamock.js"></script>
-->

<h1>Earth Computing</h1>
<h2>cells:</h2>

<script> // https://bl.ocks.org/mbostock/5100636

var kv = document.URL.split('?')[1].split('&').map(function(d) { return d.split('='); });
var o = {}; kv.forEach(function(d) { o[d[0]] = d[1]; }); // convert to a hash

$('h2').html('Cell: '+o.machineName);
var machineColor = o.color;
var tau = 2 * Math.PI; // http://tauday.com/tau-manifesto
var siz = 150;
var wid = siz, ht = siz;
var svg;
var boxColor = "#c0cfd3";
// computes path string from endAngle
var arc = d3.arc().innerRadius(Math.floor(0.5*siz/2)).outerRadius(Math.floor(0.8*siz/2)).startAngle(0);
var background, arcTop, center; // very kludgy

var TableWith3Rows = function(parent) {
    var table = $('<table>').attr({ cellspacing: 0 });
    var r1 = $('<tr>'),
        r2 = $('<tr>'),
        r3 = $('<tr>'),
        r4 = $('<tr>');
    table.append(r1).append(r2).append(r3).append(r4).css({ background: boxColor });
    table.css({ background: 'none' });
    $('body').append(table);

    var self = {
        addColumn: function(id) { // adds a column to the table for a port's data
            cell11 = $('<td>').attr({ id: "count_" + id, class: 'column' + id + " tdForCount", align: "center", valign: "middle" }).css({ background: boxColor });
            cell21 = $('<td>').attr({ id: "meter_" + id, class: 'column' + id }).css({ background: boxColor });
            cell31 = $('<td>').attr({ id: "send_" + id , class: 'column' + id + " tdForButton", align: "center", valign: "middle" });
            cell41 = $('<td>').attr({ id: "recv_" + id , class: 'column' + id + " tdForRecv"  , align: "center", valign: "middle" });

            r1.append(cell11);
            r2.append(cell21);
            r3.append(cell31);
            r4.append(cell41);

            $('td').css({ width: siz });
            $('.tdForCount' ).attr({ height: 50 }); // height is a min value
            $('.tdForButton').attr({ height: 70 }); // height is a min value
            $('.tdForRecv' ).attr({ height: 150 });

            if (id == undefined) { return; } // kludge

            // init content NOT part of the table layout
            cell11.append($('<div>').attr({ id: "counter_" + id, class: "count" }).html(" --- "));
// socket I/O
            cell31.append(
                $('<div>').attr({ id: "counter_" + id, class: "count" }).append(
                    $('<button>').data('id', id).attr({ id: "sendButton_"+id, class: "med" }).css({ height: 45 }).html('Send').on('click', function(d) {
                        var clr = $(this).css("background-color"); // is a string, we need the rbg fn
                        $(this).css({ "background-color": 'pink' });
                        var obj = $(this);
                        var oldString = $("#AITMsgBody")[0].value;
                        setTimeout(function() { obj.css({ "background-color": clr }); }, 1500);
                        setTimeout(function() { if($("#AITMsgBody")[0].value == oldString) { $("#AITMsgBody")[0].value = ''; } }, 3000);
                        // alert('socket: '+$(this).data('id')+'___'+$("#AITMsgBody")[0].value);
// Send Buttom
                        sendPacket(parseInt(id), $("#AITMsgBody")[0].value);
                    })
                )
            );
            cell41.append(
                $('<div>').attr({ id: "recvBody_" + id, class: "r45 med" }).html("-----")
            );

            $('#recv_undefined').html('RECV: ').attr({ class: 'med' })

            var svg = d3.select("#meter_" + id).append("svg").attrs({ id: "svg_" + id, width: wid, height: ht });
            var g = svg.append("g").attr("transform", "translate("+ svg.attr("width")/2 +", "+ svg.attr("height")/2 +")"); // origin at center
            background = g.append("path").style("fill", "#ddd").datum({ endAngle: tau }).attr("d", arc); // datum is used by ard
            arcTop = g.append("path").datum({ endAngle: 0 }).style("fill", "orange").attrs({ class: "gauge", "d": arc });
            center = g.append("circle").attrs({ cx: 0, cy: 0, r: 0.5*siz/2 }).style('fill', 'red');
            return self; // instead of returning self, maybe want fns to access the cells of the columns
        }
    };
    return self;
};

// FIXME : add text widget & log for CellAgent messages

$().ready(function() {
    $('body').css({ background: machineColor });

    var table = TableWith3Rows($('body'));
    table.addColumn(); // kludge, add left column just to space things over a bit
    table.addColumn('1');
    table.addColumn('2'); // enp6s0
    table.addColumn('3');
    table.addColumn('4');

    var inp = $("<input>").attr({ id: "AITMsgBody", class: "med" });
    inp.css('border', '6px solid #999');
    inp.css('border-radius', '10px');
    inp.css('margin-left', '100px');
    inp.css('padding-left', '10px');
    $('body').append('<br/>').append('<br/>').append('<br/>').append('<br/>').append(inp);

    attachSpinners(); // should only do this once
});

var tau = 2 * Math.PI; // http://tauday.com/tau-manifesto

var animateRot = function(val0, val, $select) {
    var tau = 2 * Math.PI; // http://tauday.com/tau-manifesto
    var deg = function(val, dur) { return $select.transition().duration(dur?dur: 500).attrTween("d", arcTween((val/360)*tau)); };
    var rot = function(rotTime, cnt, finiFn) {
        if (cnt > 0) {
            $select.transition().duration(rotTime).attrTween("d", arcTween(tau))
                .on("end", function() { deg(0, 1).on("end", function() { rot(rotTime, cnt-1, finiFn); }); });
        }
        else {
            finiFn();
        }
    };

    var duration = 500; // might need to up this
    var fullScale = 1000; // one revolution is 10

    var revs0 = Math.floor(val0/fullScale);
    var revs = Math.floor( val/fullScale);
    var rots = revs-revs0-1; // 360 rotations

    if (revs0 == revs) {
        $select.transition().duration(duration).attrTween("d", arcTween((val%fullScale)/fullScale*tau)); // deg
        return;
    }

    if (rots > 2) { rots = 2; }

    var startAng = val0%fullScale; // fraction of 360deg sweep
    var finiAng = val %fullScale;
    var deltaAng = (fullScale-val0%fullScale) + rots*fullScale + val%fullScale;
    // break up the duration by how much sweep occurs
    var durationTilTau = duration*(fullScale-val0%fullScale)/deltaAng;
    var durationEaRot = (rots == 0) ? 0 : duration*((rots*fullScale)/deltaAng)/rots;
    var durationAfterTau = duration*(val%fullScale /deltaAng);
    //console.log(rots, '--', durationTilTau, durationEaRot, durationAfterTau);

    var finishFn = function() { // .on("end', .. does not allow passing back an obj, so we must pass this fn in
        $select.transition().duration(durationAfterTau).attrTween("d", arcTween((val%fullScale)/fullScale*tau)); // deg
    };
    $select.transition().duration(durationTilTau).attrTween("d", arcTween(tau)) // do the start
        .on("end", function() { deg(0, 1).on("end", function() { rot(durationEaRot, rots, finishFn); }); }); // do the rots & end
};

var SpinnerIcon = function(g, cx, cy, r) {
    var fac = Math.PI/180;
    var pts = $.map([0, 90, 180, 270, 0], function(ang) { return [[cx+r*Math.cos(fac*ang), cy+r*Math.sin(fac*ang)]]; });
    for(var i = 0; i < pts.length-1; i++) {
        g.append('path')
            //.attr('class', 'circlx').attr('stroke-width', 25).attr('stroke', ['lime', 'orange', 'black', 'orange'][i])
            .attr('class', 'circlx').attr('stroke-width', 25).attr('stroke', ['black', 'orange', 'black', 'orange'][i])
            .attr('fill', 'transparent')
            .attr('d', "M"+pts[i][0]+"  "+pts[i][1]+"   A "+r+" "+r+" 0 0 1 "+pts[i+1][0]+" "+pts[i+1][1])
        ;
  }
  return g;
};

var Spinner = function(parent, cx, cy, r) {
    var g = parent.append('g');
    var icon = SpinnerIcon(g, cx, cy, r); // spinner1 is g
    g.attr("transform-origin", cx+"px "+cy+"px" );
    var cnt = 0
    var spinProcess;
    return {
        start: function() {
            if (!spinProcess) {
                spinProcess = setInterval(function() {
                    cnt++;
                    var str = ' rotate('+cnt*7+'deg);';
                    g.attr('style', 'transform: '+str);
                }, 50);
            }
        },
        stop: function() {
            clearInterval(spinProcess);
            spinProcess = null;
        }
    };
};

var spinners = [];
var attachSpinners = function() {
    $.map([1, 2, 3, 4], function(port) {
        d3.selectAll('#svg_'+port+' path').remove();
        spinners[port] = Spinner(d3.select('#svg_'+port+' g'), 0, 0, 50);
    });
};

var p_messages = [ "", "", "", "" ];

// input event(s)
var processPacket = (function() {
    var val0 = {};
    var duration = 400;
    return function(packet) {
        var val = parseInt(packet.entlCount);
        var port = deviceName2port[packet.deviceName];
        var entlState = packet.entlState;
        var msg = packet.AITRecieved;

        $('#counter_'+port).html(val%10000);

        var clr = (entlState == "UNKNOWN" || entlState == "IDLE") ? 'red'
            : ((entlState == "HELLO" || entlState == "WAIT") ? 'yellow' : 'green');

        if (clr == 'green') { spinners[port].start(); } else { spinners[port].stop(); }

        $('#svg_'+port+' circle').css({ fill: clr }); // d3.select('#svg_'+port+' circle').style("fill", clr );

        if (p_messages[port] != msg) {
            $('#recvBody_'+port).html(msg);
            $('#recv_'+port).css({ "background-color": "pink" });
            setTimeout(function() { $('#recv_'+port).css({ "background-color": "transparent" }); }, 1500);
            p_messages[port] = msg;
        }
    };
})();

// =============================== the real stuff
var socket = io();

// input event(s)
socket.on("earth-update", function(data) {
    data = JSON.parse(data.toString());
    processPacket(data);
});

var deviceName2port = { // zzzz how get port ids for a cell
    enp6s0: '1',
    enp7s0: '4',
    enp8s0: '2',
    enp9s0: '3'
}

var port2deviceName = { // zzzz how get port ids for a cell
    1: 'enp6s0',
    4: 'enp7s0',
    2: 'enp8s0',
    3: 'enp9s0'
}

// sendPacket(port_no, $("#AITMsgBody")[0].value);
// output event(s)
var sendPacket = function(source, msg) {
    var port = port2deviceName[source];
    var data = { "message": msg, "port" : port };
    socket.emit("aitMessage", data);
};

// output event(s)
function sendMessage(formi, i) {
    var message = formi.inputbox.value;
    formi.inputbox.value = '';
    var data = { "message": message, "port" : i };
    console.log(data);
    console.log(socket);
    socket.emit("aitMessage", data);
}

// =============================== the mock stuff

var runMockData = function(data) {
    var len = data.length;
    var cntr = 0; // takes ea item from buffer
    var fn = function() {
        processPacket(data[cntr]);
        cntr++
    }
    var randomDelays = function() { setTimeout(function() { fn();randomDelays(); }, Math.random()*2000); };
    randomDelays();
};

function arcTween(newAngle) {
    return function(d) {
        var interpolate = d3.interpolate(d.endAngle, newAngle);
        return function(t) {
            d.endAngle = interpolate(t);
            return arc(d);
        };
    };
}

</script>
