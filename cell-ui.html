<!DOCTYPE html>
<meta charset="utf-8">
<html lang="en">
<head>
<style>
    table { background: 'red'; cellspacing: 0; }
    table, td {  border: 0px solid black; background: 'none'; }

    .count { font-family: 'Arial Black', 'Arial Bold', Gadget, sans-serif;
        font-size: 45px; font-style: normal; font-variant: normal; font-weight: 500; line-height: 15.4px;
    }

    .med { font-family: 'Arial Black', 'Arial Bold', Gadget, sans-serif;
        font-size: 35px; font-style: normal; font-variant: normal; font-weight: 500; line-height: 30.4px;
        fill: none;
    }

    h2 { font-family: 'Arial Black', 'Arial Bold', Gadget, sans-serif;
        font-size: 60px; font-style: normal; font-variant: normal; font-weight: 500; line-height: 15.4px;
    }

    #AITMsgBody {
        border: 6px solid #999;
        border-radius: 10px;
        margin-left: 100px;
        padding-left: 10px;
    }

    path  {
        fill: 'blue'
    }

    .btn-lg, .btn-group-lg>.btn {
        padding: 10px 16px;
        font-size: 18px;
        line-height: 1.33;
        border-radius: 6px;
    }

    .r45 {
        transform: rotate(60deg);
    }
</style>

<!--
<script src='offline/jquery.js' type='text/javascript'></script>
<script src='offline/d3.min.js' type="text/Javascript"></script>
<script src='offline/d3-selection-multi.min.js' type="text/Javascript">implements .attrs for d3.v4 GGG</script>
-->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.min.css">
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://d3js.org/d3-selection-multi.v1.min.js"></script>
<script src="node_modules/socket.io-client/dist/socket.io.js"></script>
</head>
<body>
<h1>Earth Computing</h1>
<h2 id='machineName'>Cell: machineName</h2>

<table id='driverState'>
<tr id='row1'/>
<tr id='row2'/>
<tr id='row3'/>
<tr id='row4'/>
</table>

<h3 id='aim_msg'>CellAgent:</h3>
outbound: <input id='AITMsgBody' class='med'/>
<br/>

<h3 id='logs'>logs:</h3>
<div id="tabs">
  <ul>
    <li><a href="#port-0"><span>CellAgent</span></a></li>
    <li><a href="#port-1"><span>Port #1 (enp6)</span></a></li>
    <li><a href="#port-2"><span>Port #2 (enp8)</span></a></li>
    <li><a href="#port-3"><span>Port #3 (enp9)</span></a></li>
    <li><a href="#port-4"><span>Port #4 (enp7)</span></a></li>
  </ul>
  <div id="port-0">
    cell agent messages:
    <div id='cellAgentLog' style="overflow-y: scroll; height:400px;"> </div>
  </div>
  <div id="port-1">
    port 1: enp6
    <div id='port1' style="overflow-y: scroll; height:400px;"> </div>
  </div>
  <div id="port-2">
    port 2: enp8
    <div id='port2' style="overflow-y: scroll; height:400px;"> </div>
  </div>
  <div id="port-3">
    port 3: enp9
    <div id='port3' style="overflow-y: scroll; height:400px;"> </div>
  </div>
  <div id="port-4">
    port 4: enp7
    <div id='port4' style="overflow-y: scroll; height:400px;"> </div>
  </div>
</div>
 
<!-- injected operation -->
<div id='cellAgentRecv' class='frame'> ABCD </div>

<script>
$("#tabs").tabs();
</script>

<script> // https://bl.ocks.org/mbostock/5100636

function setMachineName(machineName) {
    $('#machineName').html('Cell: ' + machineName);
}

var kv = document.URL.split('?')[1].split('&').map(function(d) { return d.split('='); });
var o = {}; kv.forEach(function(d) { o[d[0]] = d[1]; }); // convert to a hash

// mandatory arguments:
var machineName = o.machineName;
var machineColor = o.color;

// --

var tau = 2 * Math.PI; // http://tauday.com/tau-manifesto

var boxColor = '#c0cfd3';
var siz = 150;
var wid = siz;
var ht = siz;

// computes path string from endAngle
var g_arc = d3.arc()
    .innerRadius(Math.floor(0.5 * siz / 2))
    .outerRadius(Math.floor(0.8 * siz / 2))
    .startAngle(0);

var svg;

// unused ??
var g_background;
var g_arcTop;
var g_center; // very kludgy

// --

// mechanical connector ordering
var port2deviceName = {
    1: 'enp6s0',
    2: 'enp8s0',
    3: 'enp9s0',
    4: 'enp7s0'
}

var deviceName2port = {
    enp6s0: '1',
    enp7s0: '4',
    enp8s0: '2',
    enp9s0: '3'
}

var spinners = [];
var p_messages = [ '', '', '', '' ];

// --

setMachineName(machineName);

var tableBuilder = function(table) {
    var r1 = $('#row1');
    var r2 = $('#row2');
    var r3 = $('#row3');
    var r4 = $('#row4');

    table.attr({ cellspacing: 0 });
    table.css({ background: boxColor });
    table.css({ background: 'none' });

    var self = {
        addColumn: function(id) { // adds a column to the table for a port's data
            cell1 = $('<td>').attr({ id: 'count_' + id, class: 'column' + id + ' tdForCount', align: 'center', valign: 'middle' });
            cell2 = $('<td>').attr({ id: 'meter_' + id, class: 'column' + id });
            cell3 = $('<td>').attr({ id: 'send_'  + id, class: 'column' + id + ' tdForButton', align: 'center', valign: 'middle' });
            cell4 = $('<td>').attr({ id: 'recv_'  + id, class: 'column' + id + ' tdForRecv'  , align: 'center', valign: 'middle' });

            r1.append(cell1);
            r2.append(cell2);
            r3.append(cell3);
            r4.append(cell4);

            cell1.css({ background: boxColor });
            cell2.css({ background: boxColor });

            $('td').css({ width: siz });
            $('.tdForCount' ).attr({ height:  50 }); // height is a min value
            $('.tdForButton').attr({ height:  70 }); // height is a min value
            $('.tdForRecv'  ).attr({ height: 150 });

            if (id == undefined) { return; } // kludge

            // animates send operation:
            var click_fcn = function(d) {
                var oldString = $('#AITMsgBody')[0].value;
                var obj = $(this);
                var clr = obj.css('background-color');
                obj.css({ 'background-color': 'pink' });
                setTimeout(function() { obj.css({ 'background-color': clr }); }, 1500);
                setTimeout(function() { if ($('#AITMsgBody')[0].value == oldString) { $('#AITMsgBody')[0].value = ''; } }, 3000);
                sendPacket(parseInt(id), oldString);
            };
            var button = $('<button>').data('id', id).attr({ id: 'sendButton_' + id, class: 'med' }).css({ height: 45 }).html('Send').on('click', click_fcn)

            // init content NOT part of the table layout
            cell1.append($('<div>').attr({ id: 'counter_' + id, class: 'count' }).html(' --- '));
            cell3.append($('<div>').attr({ id: 'counter_' + id, class: 'count' }).append(button));
            cell4.append($('<div>').attr({ id: 'recvBody_' + id, class: 'r45 med' }).html('-----'));

            $('#recv_undefined').html('RECV: ').attr({ class: 'med' })

            // cell2
            var svg = d3.select('#meter_' + id).append('svg').attrs({ id: 'svg_' + id, width: wid, height: ht });
            var f = 'translate(' + svg.attr('width') / 2 + ', ' + svg.attr('height') / 2 + ')'; // origin at center
            var g = svg.append('g').attr('transform', f);

            g_background = g.append('path').style('fill', '#ddd').datum({ endAngle: tau }).attr('d', g_arc); // datum is used by ard
            g_arcTop = g.append('path').datum({ endAngle: 0 }).style('fill', 'orange').attrs({ class: 'gauge', 'd': g_arc });
            g_center = g.append('circle').attrs({ cx: 0, cy: 0, r: 0.5 * siz / 2 }).style('fill', 'red');

            return self;
        }
    };
    return self;
};

$().ready(function() {
    $('body').css({ background: machineColor });

    var table = $('#driverState');
    var builder = tableBuilder(table);
    builder.addColumn(); // kludge, space things over a bit
    builder.addColumn('1');
    builder.addColumn('2');
    builder.addColumn('3');
    builder.addColumn('4');

    attachSpinners(); // should only do this once
});

function arcTween(newAngle) {
    return function(d) {
        var interpolate = d3.interpolate(d.endAngle, newAngle);
        return function(t) {
            d.endAngle = interpolate(t);
            return g_arc(d);
        };
    };
}

var duration = 500; // might need to up this
var fullScale = 1000; // one revolution is 10

var animateRot = function(val0, val, $select) {
    var revs0 = Math.floor(val0 / fullScale);
    var revs = Math.floor( val / fullScale);

    var deg = function(val, dur) { return $select.transition().duration(dur ? dur : 500).attrTween('d', arcTween((val / 360) * tau)); };
    var rot = function(rotTime, cnt, finiFn) {
        if (cnt > 0) {
            var fn0 = function() { rot(rotTime, cnt - 1, finiFn); };
            var fn1 = function() { deg(0, 1).on('end', fn0); };
            $select.transition().duration(rotTime).attrTween('d', arcTween(tau)).on('end', fn1);
        }
        else {
            finiFn();
        }
    };

    var rots = revs - revs0 - 1; // 360 rotations
    if (revs0 == revs) {
        $select.transition().duration(duration).attrTween('d', arcTween((val % fullScale) / fullScale * tau)); // deg
        return;
    }

    if (rots > 2) { rots = 2; }

    var startAng = val0 % fullScale; // fraction of 360 deg sweep
    var finiAng = val % fullScale;
    var deltaAng = (fullScale - val0 % fullScale) + rots * fullScale + val % fullScale;
    // break up the duration by how much sweep occurs
    var durationTilTau = duration * (fullScale - val0 % fullScale) / deltaAng;
    var durationEaRot = (rots == 0) ? 0 : duration * ((rots * fullScale) / deltaAng) / rots;
    var durationAfterTau = duration * (val % fullScale /deltaAng);

    var finishFn = function() { // .on('end', .. does not allow passing back an obj, so we must pass this fn in
        $select.transition().duration(durationAfterTau).attrTween('d', arcTween((val % fullScale) / fullScale * tau)); // deg
    };
    {
        var fn0 = function() { rot(durationEaRot, rots, finishFn); };
        var fn1 = function() { deg(0, 1).on('end', fn0); };
        $select.transition().duration(durationTilTau).attrTween('d', arcTween(tau)).on('end', fn1);
    }
};

var SpinnerIcon = function(g, cx, cy, r) {
    var fac = Math.PI / 180;
    var pts_fn = function(ang) { var arc = fac * ang; var x = r * Math.cos(arc); var y = r * Math.sin(arc); return [[cx + x, cy + y]]; };
    var pts = $.map([0, 90, 180, 270, 0], pts_fn);
    for (var i = 0; i < pts.length - 1; i++) {
        var x1 = pts[i][0];
        var y1 = pts[i][1];
        var x2 = pts[i + 1][0];
        var y2 = pts[i + 1][1];
        var d = 'M' + x1 + ' ' + y1 + ' A' + ' ' + r + ' ' + r + ' 0 0 1' + ' ' + x2 + ' ' + y2;
        g.append('path')
            .attr('class', 'circlx').attr('stroke-width', 25)
            .attr('stroke', ['black', 'orange', 'black', 'orange'][i])
         // .attr('stroke', ['lime',  'orange', 'black', 'orange'][i])
            .attr('fill', 'transparent')
            .attr('d', d)
        ;
    }
    return g;
};

var Spinner = function(parent, cx, cy, r) {
    var g = parent.append('g');
    var icon = SpinnerIcon(g, cx, cy, r); // spinner1 is g
    g.attr('transform-origin', cx + 'px ' + cy + 'px' );
    var cnt = 0
    var spin_fn = function() {
        cnt++;
        var deg = cnt * 7;
        var xform = 'rotate(' + deg + 'deg);';
        g.attr('style', 'transform: ' + xform);
    };
    var spinProcess;
    return {
        start: function() {
            if (!spinProcess) spinProcess = setInterval(spin_fn, 50);
        },
        stop: function() {
            clearInterval(spinProcess);
            spinProcess = null;
        }
    };
};

var attachSpinners = function() {
    $.map([1, 2, 3, 4], function(port) {
        d3.selectAll('#svg_' + port + ' path').remove();
        var port_g = d3.select('#svg_' + port + ' g');
        spinners[port] = Spinner(port_g, 0, 0, 50);
    });
};

var processPacket = (function() {
    return function(packet) {
        var val = parseInt(packet.entlCount);
        var port = deviceName2port[packet.deviceName];
        var entlState = packet.entlState;
        var msg = packet.AITRecieved;

        $('#counter_' + port).html(val % 10000);

        var clr = (entlState == 'UNKNOWN' || entlState == 'IDLE') ? 'red'
                : (entlState == 'HELLO'   || entlState == 'WAIT') ? 'yellow' : 'green';

        if (clr == 'green') { spinners[port].start(); } else { spinners[port].stop(); }

        $('#svg_' + port + ' circle').css({ fill: clr }); // d3.select('#svg_'+port+' circle').style('fill', clr );

        if (p_messages[port] != msg) {
            $('#recvBody_' + port).html(msg);
            $('#recv_' + port).css({ 'background-color': 'pink' });
            setTimeout(function() { $('#recv_' + port).css({ 'background-color': 'transparent' }); }, 1500);
            p_messages[port] = msg;
        }
    };
})();

// FIXME : folded 7-bit ASCII
function dumper(frame) {
    var str = "";
    for (var i = 0; i < frame.length; i += 2) {
        var hexstr = frame.substr(i, 2);
        var ch = parseInt('0x' + hexstr, 16);
        str += String.fromCharCode(ch); // FIXME
        if ((i % 160) > 157) str += "\n";
    }
    return str;
}

var processCellAgent = (function() {
    return function(msg) {
        console.log('cellagent-update:', machineName, msg);
        var nickname = msg.nickname;
        if (machineName != nickname) return;

        var epoch = msg.epoch;
        var cell_id = msg.pe_id;
        var port = msg.outbound;
        var tree = msg.tree;
        var frame = msg.frame;
        var ait_code = msg.ait_code;
        var msg_id = msg.msg_id;
        var msg_type = msg.msg_type;

        var content = '<b class="med">'
                + '<p/>'
            + '<br/>' + msg_type
            + '<br/>' + ' port: ' + port
            + '<br/>' + ' tree: ' + tree
            + '<br/>' + ' epoch: ' + epoch
            + '<br/>' + ' msg_id: ' + msg_id
                + '</b>'
                + '<p/>'
            + '<br/>' + ' cell_id: ' + cell_id
            + '<br/>' + ' nickname: ' + nickname
            + '<br/>' + ' machineName: ' + machineName
            + '<br/>' + ' ait_code: ' + ait_code
            + '<br/>' + ' frame: '
                + '<br/>' + '<pre>' + dumper(frame) + '</pre>'
        ;
        $('#cellAgentRecv').html(content);

        xmit(port, msg_type);
    };
})();

function xmit(port, msg_type) {
    var ca_line = ''
        + '<br/>' + ' port: ' + port + ' <font color="red">xmit:</font> ' + msg_type
    ;
    $('#cellAgentLog').append(ca_line);
        var port_line = ''
            + '<br/>' + '<font color="red">xmit:</font> ' + msg_type
        ;
        $('#port'+port).append(port_line);
}

function recv(port, msg_type) {
    var ca_line = ''
        + '<br/>' + ' port: ' + port + ' <font color="blue">recv:</font> ' + msg_type
    ;
    $('#cellAgentLog').append(ca_line);
        var port_line = ''
            + '<br/>' + '<font color="blue">recv:</font> ' + msg_type
        ;
        $('#port'+port).append(port_line);
}

// =============================== the real stuff

var socket = io();

// earth-update { machineName deviceName linkState entlState entlCount AITSent AITRecieved }
socket.on('earth-update', function(data) {
    data = JSON.parse(data.toString()); // why?
    processPacket(data);
});

// cellagent-update { port tree frame }
socket.on('cellagent-update', function(data) {
    // data = JSON.parse(data.toString()); // why not?
    processCellAgent(data);
});

// driver-update { port message }
var sendPacket = function(source, msg) {
    var port = port2deviceName[source];
    var data = { 'message': msg, 'port': port };
    socket.emit('aitMessage', data);
};

// unused ?
function sendMessage(formi, i) {
    var message = formi.inputbox.value;
    formi.inputbox.value = '';
    var data = { 'message': message, 'port': i };
    console.log(data);
    console.log(socket);
    socket.emit('aitMessage', data);
}

// =============================== the mock stuff

var runMockData = function(data) {
    var len = data.length;
    var cntr = 0; // takes ea item from buffer
    var fn = function() {
        processPacket(data[cntr]);
        cntr++
    }
    var randomDelays = function() { setTimeout(function() { fn();randomDelays(); }, Math.random() * 2000); };
    randomDelays();
};

</script>
</body>
</html>
